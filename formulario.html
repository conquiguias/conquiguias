<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario de Asistencia</title>
</head>
<body>
  <img src="logo1.png" style="width: 25%;" alt="">
  <h2 id="tituloFormulario">Cargando...</h2>
  <p id="contador"></p>

  <form id="formulario" style="display: none;">
    <input type="hidden" name="id" id="idFormulario">

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Correo:</label><br>
    <input type="email" name="correo" required><br><br>

    <label>TelÃ©fono:</label><br>
    <input type="tel" name="telefono" required><br><br>

    <label>AsociaciÃ³n o campo:</label><br>
    <input type="text" name="asociacion" required><br><br>

    <button type="submit">Registrar Primera Asistencia</button>
  </form>

  <!-- Botones dinÃ¡micos -->
  <div id="botonesAsistencia" style="margin-top:20px; display:none;">
    <button id="btnSegunda" style="display:none;">Registrar Segunda Asistencia</button>
    <button id="btnTercera" style="display:none;">Registrar Tercera Asistencia</button>
  </div>

  <p id="mensaje"></p>

  <h3>ğŸ“Š Respuestas registradas | Se actualiza cada 5 minutos.</h3>
  <p id="contadorRecarga">ğŸ”„ PrÃ³xima recarga en: <span id="segundos">300</span> segundos</p>

  <p>InformaciÃ³n exclusiva para instructores y directores. Su informaciÃ³n es borrada despuÃ©s de 90 dÃ­as.</p>
  <table border="1" id="tablaRespuestas" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr>
        <th>#</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>TelÃ©fono</th>
        <th>AsociaciÃ³n</th>
        <th>NÃºmero Asistencia</th>
        <th>Â¿AsistiÃ³?</th>
        <th>Examen</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const form = document.getElementById("formulario");
    const idInput = document.getElementById("idFormulario");
    const titulo = document.getElementById("tituloFormulario");
    const contador = document.getElementById("contador");
    const tabla = document.getElementById("tablaRespuestas");
    const mensaje = document.getElementById("mensaje");
    
    let etapaActual = 1;
    let correoUsuario = null;
    let cronometroInterval = null;
    
    const DURACIONES = {
      1: 30 * 60 * 1000, // 30 minutos
      2: 30 * 60 * 1000,
      3: 10 * 60 * 1000
    };
    
    // ğŸ§  Cargar estado al abrir
    window.addEventListener("DOMContentLoaded", async () => {
      const estado = JSON.parse(localStorage.getItem("asistenciaEstado"));
      const correoGuardado = localStorage.getItem("correoUsuario");
    
      if (correoGuardado) correoUsuario = correoGuardado;
    
      if (estado && correoUsuario && estado.correo === correoUsuario) {
        const restante = estado.duracion - (Date.now() - estado.inicio);
        etapaActual = estado.etapa;
        if (restante > 0) {
          iniciarCronometro(restante / 1000, etapaActual);
          form.style.display = "none";
          titulo.textContent = `Esperando siguiente asistencia (${etapaActual})...`;
        } else {
          avanzarEtapa();
        }
      } else {
        form.style.display = "block";
        titulo.textContent = "Registro de Primera Asistencia";
      }
    
      if (correoUsuario) await cargarTabla();
    });
    
    // ğŸ“‹ Enviar formulario
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
    
      const datos = Object.fromEntries(new FormData(form).entries());
      correoUsuario = datos.correo;
      localStorage.setItem("correoUsuario", correoUsuario);
    
      const resp = await fetch("/api/guardar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...datos, id: idInput.value })
      });
    
      const data = await resp.json();
      if (data.success) {
        alert(data.message);
        form.style.display = "none";
        etapaActual = data.numeroAsistencia;
        guardarEstado(etapaActual);
        iniciarCronometro(DURACIONES[etapaActual] / 1000, etapaActual);
        await cargarTabla();
      } else {
        alert("âš ï¸ " + data.error);
      }
    });
    
    // ğŸ•’ Iniciar cronÃ³metro persistente
    function iniciarCronometro(segundos, etapa) {
      clearInterval(cronometroInterval);
      let tiempoRestante = segundos;
    
      cronometroInterval = setInterval(() => {
        if (tiempoRestante <= 0) {
          clearInterval(cronometroInterval);
          contador.textContent = "â° Tiempo finalizado";
          avanzarEtapa();
          return;
        }
        const min = Math.floor(tiempoRestante / 60);
        const sec = tiempoRestante % 60;
        contador.textContent = `Asistencia ${etapa}: ${min}:${sec.toString().padStart(2, "0")}`;
        tiempoRestante--;
      }, 1000);
    }
    
    // ğŸ’¾ Guardar estado actual
    function guardarEstado(etapa) {
      localStorage.setItem("asistenciaEstado", JSON.stringify({
        correo: correoUsuario,
        etapa,
        inicio: Date.now(),
        duracion: DURACIONES[etapa]
      }));
    }
    
    // â­ï¸ Avanzar etapa
    function avanzarEtapa() {
      etapaActual++;
      if (etapaActual > 3) {
        contador.textContent = "âœ… Completaste todas las asistencias.";
        titulo.textContent = "Â¡Gracias por completar tus asistencias!";
        localStorage.removeItem("asistenciaEstado");
        return;
      }
      localStorage.removeItem("asistenciaEstado");
      form.style.display = "block";
      titulo.textContent = `Registro de Asistencia ${etapaActual}`;
      form.querySelector("button").textContent = `Registrar Asistencia ${etapaActual}`;
    }
    
    // ğŸ“Š Cargar tabla desde GitHub
    async function cargarTabla() {
      try {
        const resp = await fetch(`/api/leer?correo=${encodeURIComponent(correoUsuario)}`);
        const data = await resp.json();
        if (data.success) {
          actualizarTabla(data.asistencias);
        }
      } catch (err) {
        console.error("Error al cargar tabla:", err);
      }
    }
    
    // ğŸ”„ Actualizar tabla completa
    function actualizarTabla(asistencias) {
      const tbody = tabla.querySelector("tbody");
      tbody.innerHTML = "";
    
      asistencias.forEach((r, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${r.nombre}</td>
          <td>${r.correo}</td>
          <td>${r.telefono || ""}</td>
          <td>${r.asociacion || ""}</td>
          <td>${r.numeroAsistencia}</td>
          <td>${r.asistio}</td>
          <td>${r.asistio === "SÃ­" && r.numeroAsistencia === 3 ? "ğŸ“ Hacer Examen" : "No puede hacer examen"}</td>
          <td>${new Date(r.fecha).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    </script>
    
    
    
    
</body>
</html>
