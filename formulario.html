<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Formulario</title>
</head>

<body>
  <img src="logo1.png" style="width: 25%;" alt="">
  <h2 id="tituloFormulario">Cargando...</h2>
  <p id="contador"></p>

  <form id="formulario" style="display: none;">
    <input type="hidden" name="id" id="idFormulario">

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Correo: (Opcional)</label><br>
    <input type="email" name="correo"><br><br>

    <label>Edad: (Opcional)</label><br>
    <input type="number" name="edad"><br><br>

    <label>Tel√©fono:</label><br>
    <input type="tel" name="telefono" required><br><br>

    <label>Asociaci√≥n o campo:</label><br>
    <input type="text" name="asociacion" required><br><br>

    <button type="submit">Enviar</button>
  </form>
<!-- Botones de asistencia -->
<div id="botonesAsistencia" style="margin-top:20px; display:none;">
  <button id="btnPrimera">Registrar Primera Asistencia</button>
  <button id="btnSegunda" style="display:none;">Registrar Segunda Asistencia</button>
  <button id="btnTercera" style="display:none;">Registrar Tercera Asistencia</button>
</div>

<script>
let visitanteId = localStorage.getItem("visitanteId");
if (!visitanteId) {
  visitanteId = crypto.randomUUID();
  localStorage.setItem("visitanteId", visitanteId);
}

document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(location.search);
  const id = params.get("id");
  if (!id) return;

  let registros = [];
  async function cargarRespuestas() {
    const res = await fetch(`/api/verRespuestas?id=${id}`);
    registros = await res.json();
    const tbody = document.querySelector("#tablaRespuestas tbody");
    tbody.innerHTML = "";
    registros.forEach((r, index) => {
      r.asistencias.forEach((asistio, i) => {
        let examen = "-";
        if (r.asistencias.every(a => a === true)) {
          examen = `<button onclick="alert('Hacer examen de ${r.nombre}')">Hacer Examen</button>`;
        } else if (i === r.asistencias.length - 1) examen = "No puede hacer examen";
        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${index + 1}</td>
            <td>${r.nombre}</td>
            <td>${r.correo || "-"}</td>
            <td>${r.edad || "-"}</td>
            <td>${r.telefono}</td>
            <td>${r.asociacion}</td>
            <td>${i+1}</td>
            <td>${asistio ? "S√≠" : "No"}</td>
            <td>${i === 2 ? examen : "-"}</td>
          </tr>
        `);
      });
    });
  }

  await cargarRespuestas();

  // üîπ Mostrar botones seg√∫n asistencias previas
  const registroUsuario = registros.find(r => r.visitanteId === visitanteId);
  const btnPrimera = document.getElementById("btnPrimera");
  const btnSegunda = document.getElementById("btnSegunda");
  const btnTercera = document.getElementById("btnTercera");
  document.getElementById("botonesAsistencia").style.display = "block";

  if (!registroUsuario) {
    btnPrimera.style.display = "inline-block";
  } else if (registroUsuario.asistencias[0] && !registroUsuario.asistencias[1]) {
    btnSegunda.style.display = "inline-block";
  } else if (registroUsuario.asistencias[1] && !registroUsuario.asistencias[2]) {
    btnTercera.style.display = "inline-block";
  }

  async function registrarAsistencia(num) {
    const res = await fetch("/api/guardar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id,
        visitanteId,
        numeroAsistencia: num,
        nombre: document.querySelector("input[name=nombre]").value,
        correo: document.querySelector("input[name=correo]").value,
        telefono: document.querySelector("input[name=telefono]").value,
        edad: document.querySelector("input[name=edad]").value,
        asociacion: document.querySelector("input[name=asociacion]").value
      })
    });
    if (res.ok) {
      await cargarRespuestas();
      btnPrimera.style.display = "none";
      btnSegunda.style.display = "none";
      btnTercera.style.display = "none";
      alert(`Asistencia #${num} registrada`);
    }
  }

  btnPrimera.addEventListener("click", () => registrarAsistencia(1));
  btnSegunda.addEventListener("click", () => registrarAsistencia(2));
  btnTercera.addEventListener("click", () => registrarAsistencia(3));

});
</script>

  
  
  

</body>

</html>