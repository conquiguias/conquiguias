<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formulario de Asistencias</title>
</head>
<body>
<img src="logo1.png" style="width:25%;" alt="">
<h2 id="tituloFormulario">Cargando...</h2>
<p id="contador"></p>

<form id="formulario" style="display:none;">
  <input type="hidden" name="id" id="idFormulario">
  <label>Nombre:</label><br>
  <input type="text" name="nombre" required><br><br>
  <label>Correo: (Opcional)</label><br>
  <input type="email" name="correo"><br><br>
  <label>Edad: (Opcional)</label><br>
  <input type="number" name="edad"><br><br>
  <label>TelÃ©fono:</label><br>
  <input type="tel" name="telefono" required><br><br>
  <label>AsociaciÃ³n o campo:</label><br>
  <input type="text" name="asociacion" required><br><br>
  <button type="submit">Enviar Primera Asistencia</button>
</form>

<div id="botonesAsistencia" style="margin-top:20px; display:none;">
  <button id="btnSegunda" disabled>Registrar Segunda Asistencia</button>
  <button id="btnTercera" disabled>Registrar Tercera Asistencia</button>
</div>

<p id="mensaje"></p>

<h3>ðŸ“Š Respuestas registradas | Se actualiza cada 5 minutos.</h3>
<p id="contadorRecarga">ðŸ”„ PrÃ³xima recarga en: <span id="segundos">300</span> segundos</p>

<table border="1" id="tablaRespuestas" style="border-collapse: collapse; width:100%;">
  <thead>
    <tr>
      <th>#</th>
      <th>Nombre</th>
      <th>Correo</th>
      <th>Edad</th>
      <th>TelÃ©fono</th>
      <th>AsociaciÃ³n</th>
      <th>NÃºmero Asistencia</th>
      <th>Â¿AsistiÃ³?</th>
      <th>Examen</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// Generar UUID
let visitanteId = localStorage.getItem("visitanteId");
if(!visitanteId){
  visitanteId = crypto.randomUUID();
  localStorage.setItem("visitanteId", visitanteId);
}

document.addEventListener("DOMContentLoaded", async ()=>{
  const params = new URLSearchParams(location.search);
  const id = params.get("id");
  if(!id) return;

  // Traer formulario desde servidor
  const resForm = await fetch(`/api/obtenerFormulario?id=${id}`);
  if(!resForm.ok){ document.body.innerHTML="<h2>Error formulario no encontrado</h2>"; return; }
  const formData = await resForm.json();
  document.getElementById("tituloFormulario").textContent = formData.titulo;
  document.getElementById("idFormulario").value = id;

  const fechaInicio = new Date(formData.fechaInicio);
  const DURACION_ASISTENCIAS = [30,30,10]; // minutos
  let acumulado=0;
  const fechaFinAsistencias = DURACION_ASISTENCIAS.map(min=>{
    acumulado+=min;
    return new Date(fechaInicio.getTime()+acumulado*60000);
  });

  const btnSegunda = document.getElementById("btnSegunda");
  const btnTercera = document.getElementById("btnTercera");
  const formulario = document.getElementById("formulario");
  const mensaje = document.getElementById("mensaje");

  async function cargarRespuestas(){
    const tablaBody = document.querySelector("#tablaRespuestas tbody");
    tablaBody.innerHTML="<tr><td colspan='9'>Cargando...</td></tr>";
    const res = await fetch(`/api/verRespuestas?id=${id}`);
    const respuestas = res.ok ? await res.json() : [];
    tablaBody.innerHTML="";
    respuestas.forEach((r,index)=>{
      r.asistencias = r.asistencias || [false,false,false];
      r.asistencias.forEach((a,i)=>{
        let examen="-";
        if(i===2) examen = r.asistencias.every(x=>x) ? `<button onclick="alert('Hacer examen de ${r.nombre}')">Hacer Examen</button>` : "No puede hacer examen";
        tablaBody.insertAdjacentHTML("beforeend",`
          <tr>
            <td>${index+1}</td>
            <td>${r.nombre}</td>
            <td>${r.correo||"-"}</td>
            <td>${r.edad||"-"}</td>
            <td>${r.telefono}</td>
            <td>${r.asociacion}</td>
            <td>${i+1}</td>
            <td>${a?"SÃ­":"No"}</td>
            <td>${examen}</td>
          </tr>
        `);
      });
    });
  }

  await cargarRespuestas();

  // Contador
  function actualizarContador(){
    const ahora = new Date();
    if(ahora>fechaFinAsistencias[2]){
      document.getElementById("contador").textContent="â›” El formulario ha caducado";
      formulario.style.display="none";
      btnSegunda.disabled=true;
      btnTercera.disabled=true;
      return;
    }
    let texto="";
    if(!formulario.dataset.registrado){
      if(ahora<fechaFinAsistencias[0]){
        const rem = fechaFinAsistencias[0]-ahora;
        const m=Math.floor(rem/60000), s=Math.floor((rem%60000)/1000);
        texto=`â³ Primera asistencia termina en ${m}:${s.toString().padStart(2,"0")}`;
      }else{
        formulario.style.display="none";
        texto="âŒ Se acabÃ³ la primera asistencia";
      }
    }else{
      if(!btnSegunda.disabled){
        const rem = fechaFinAsistencias[1]-ahora;
        const m=Math.floor(rem/60000), s=Math.floor((rem%60000)/1000);
        texto=`â³ Segunda asistencia termina en ${m}:${s.toString().padStart(2,"0")}`;
      }else if(!btnTercera.disabled){
        const rem = fechaFinAsistencias[2]-ahora;
        const m=Math.floor(rem/60000), s=Math.floor((rem%60000)/1000);
        texto=`â³ Tercera asistencia termina en ${m}:${s.toString().padStart(2,"0")}`;
      }
    }
    document.getElementById("contador").textContent=texto;
  }
  setInterval(actualizarContador,1000);

  // Comprobar usuario
  const resUsuarios = await fetch(`/api/verRespuestas?id=${id}`);
  const usuarios = resUsuarios.ok ? await resUsuarios.json() : [];
  const registroUsuario = usuarios.find(u=>u.visitanteId===visitanteId);
  if(registroUsuario){
    formulario.dataset.registrado="true";
    formulario.style.display="none";
    if(registroUsuario.asistencias[0]) btnSegunda.disabled=false;
    if(registroUsuario.asistencias[1]) btnTercera.disabled=false;
  }

  // Formulario primera asistencia
  formulario.addEventListener("submit", async e=>{
    e.preventDefault();
    const datos = Object.fromEntries(new FormData(formulario).entries());
    datos.visitanteId = visitanteId;
    datos.numeroAsistencia=1;
    const res = await fetch("/api/guardar",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(datos)
    });
    if(res.ok){
      mensaje.textContent="âœ… Primera asistencia registrada";
      formulario.style.display="none";
      formulario.dataset.registrado="true";
      btnSegunda.disabled=false;
      await cargarRespuestas();
    }else{
      mensaje.textContent="âŒ Error al registrar primera asistencia";
    }
  });

  // Segunda asistencia
  btnSegunda.addEventListener("click", async ()=>{
    const datos = {visitanteId, id, numeroAsistencia:2};
    const res = await fetch("/api/guardar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(datos)});
    if(res.ok){ 
      btnSegunda.disabled=true; 
      btnTercera.disabled=false;
      mensaje.textContent="âœ… Segunda asistencia registrada"; 
      await cargarRespuestas();
    }
  });

  // Tercera asistencia
  btnTercera.addEventListener("click", async ()=>{
    const datos = {visitanteId, id, numeroAsistencia:3};
    const res = await fetch("/api/guardar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(datos)});
    if(res.ok){ 
      btnTercera.disabled=true;
      mensaje.textContent="âœ… Tercera asistencia registrada"; 
      await cargarRespuestas();
    }
  });

  document.getElementById("botonesAsistencia").style.display="block";
});
</script>
</body>
</html>
