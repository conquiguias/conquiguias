<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario de Asistencia</title>
</head>
<body>
  <img src="logo1.png" style="width: 25%;" alt="">
  <h2 id="tituloFormulario">Cargando...</h2>
  <p id="contador"></p>

  <form id="formulario" style="display: none;">
    <input type="hidden" name="id" id="idFormulario">

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Correo:</label><br>
    <input type="email" name="correo" required><br><br>

    <label>Tel√©fono:</label><br>
    <input type="tel" name="telefono" required><br><br>

    <label>Asociaci√≥n o campo:</label><br>
    <input type="text" name="asociacion" required><br><br>

    <button type="submit">Registrar Primera Asistencia</button>
  </form>

  <!-- Botones din√°micos -->
  <div id="botonesAsistencia" style="margin-top:20px; display:none;">
    <button id="btnSegunda" style="display:none;">Registrar Segunda Asistencia</button>
    <button id="btnTercera" style="display:none;">Registrar Tercera Asistencia</button>
  </div>

  <p id="mensaje"></p>

  <h3>üìä Respuestas registradas | Se actualiza cada 5 minutos.</h3>
  <p id="contadorRecarga">üîÑ Pr√≥xima recarga en: <span id="segundos">300</span> segundos</p>

  <p>Informaci√≥n exclusiva para instructores y directores. Su informaci√≥n es borrada despu√©s de 90 d√≠as.</p>
  <table border="1" id="tablaRespuestas" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr>
        <th>#</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Tel√©fono</th>
        <th>Asociaci√≥n</th>
        <th>N√∫mero Asistencia</th>
        <th>¬øAsisti√≥?</th>
        <th>Examen</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const form = document.getElementById("formulario");
      const mensaje = document.getElementById("mensaje");
      const contador = document.getElementById("contador");
      const tabla = document.getElementById("tablaRespuestas");
    
      const botonAsistencia = document.createElement("button");
      botonAsistencia.id = "botonAsistencia";
      botonAsistencia.style.display = "none";
      document.body.insertBefore(botonAsistencia, tabla);
    
      let estado = JSON.parse(localStorage.getItem("estadoAsistencia")) || { numero: 0, ultimaHora: null };
      let correoGuardado = localStorage.getItem("correoAsistencia") || null;
    
      const params = new URLSearchParams(location.search);
      const id = params.get("id");
    
      if (!id) {
        document.body.innerHTML = "<h2>‚ùå Error: ID de formulario no especificado.</h2>";
        return;
      }
    
      // üîπ Cargar datos del formulario
      const res = await fetch(`/api/obtenerFormulario?id=${id}`);
      if (!res.ok) {
        document.body.innerHTML = `<h2>‚ùå Formulario '${id}' no encontrado.</h2>`;
        return;
      }
    
      const data = await res.json();
      document.getElementById("tituloFormulario").textContent = data.titulo;
      document.getElementById("idFormulario").value = id;
      form.style.display = "block";
    
      // üîπ Si el usuario ya se registr√≥ antes, ocultar el formulario
      if (correoGuardado && estado.numero > 0) {
        form.style.display = "none";
        mensaje.textContent = `Reanudando asistencia para ${correoGuardado}...`;
        mostrarEstado();
      }
    
      // üß≠ Registrar primera asistencia
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const datos = Object.fromEntries(new FormData(form).entries());
        correoGuardado = datos.correo.trim();
        localStorage.setItem("correoAsistencia", correoGuardado);
    
        const res = await registrarAsistencia(datos);
        if (res.success) {
          mensaje.textContent = res.message;
          form.style.display = "none";
          estado.numero = res.numeroAsistencia;
          estado.ultimaHora = new Date().toISOString();
          localStorage.setItem("estadoAsistencia", JSON.stringify(estado));
          mostrarEstado();
        } else {
          mensaje.textContent = res.error || "‚ùå Error al registrar asistencia.";
        }
      });
    
      // üîπ Mostrar estado actual
      function mostrarEstado() {
        const num = estado.numero;
        const ahora = new Date();
        const ultima = estado.ultimaHora ? new Date(estado.ultimaHora) : ahora;
        const diffMin = Math.floor((ahora - ultima) / 60000); // minutos transcurridos
    
        botonAsistencia.style.display = "none";
    
        if (num === 1) {
          if (diffMin >= 30) mostrarBoton(2);
          else iniciarContador(30 - diffMin, "Segunda", 2);
        } else if (num === 2) {
          if (diffMin >= 10) mostrarBoton(3);
          else iniciarContador(10 - diffMin, "Tercera", 3);
        } else if (num >= 3) {
          mensaje.textContent = "‚úÖ Completaste las 3 asistencias. Ya puedes hacer el examen.";
          contador.textContent = "";
          botonAsistencia.style.display = "none";
        }
      }
    
      // üîπ Cron√≥metro visible
      function iniciarContador(minutos, nombre, numero) {
        let tiempoRestante = minutos * 60;
        contador.style.display = "block";
    
        const intervalo = setInterval(() => {
          const min = Math.floor(tiempoRestante / 60);
          const seg = tiempoRestante % 60;
          contador.textContent = `‚è≥ ${nombre} asistencia disponible en ${min}:${seg
            .toString()
            .padStart(2, "0")}`;
          tiempoRestante--;
    
          if (tiempoRestante <= 0) {
            clearInterval(intervalo);
            mostrarBoton(numero);
          }
        }, 1000);
      }
    
      // üîπ Mostrar bot√≥n de segunda o tercera asistencia
      function mostrarBoton(numero) {
        contador.textContent = "";
        botonAsistencia.textContent = `Registrar ${["Primera", "Segunda", "Tercera"][numero - 1]} Asistencia`;
        botonAsistencia.style.display = "inline-block";
        mensaje.textContent = `üìã Disponible: ${["Primera", "Segunda", "Tercera"][numero - 1]} asistencia`;
    
        botonAsistencia.onclick = async () => {
          botonAsistencia.disabled = true;
          const datos = {
            id,
            correo: correoGuardado,
            nombre: localStorage.getItem("nombreAsistencia") || "Participante",
          };
          const res = await registrarAsistencia(datos);
          if (res.success) {
            mensaje.textContent = res.message;
            estado.numero = res.numeroAsistencia;
            estado.ultimaHora = new Date().toISOString();
            localStorage.setItem("estadoAsistencia", JSON.stringify(estado));
            mostrarEstado();
          } else {
            mensaje.textContent = res.error;
            botonAsistencia.disabled = false;
          }
        };
      }
    
      // üîπ Guardar asistencia en GitHub
      async function registrarAsistencia(datos) {
        try {
          const res = await fetch("/api/guardar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(datos),
          });
          const json = await res.json();
          return json;
        } catch (err) {
          console.error(err);
          return { success: false, error: "Error al conectar con el servidor." };
        }
      }
    });
    </script>
    
    
</body>
</html>
