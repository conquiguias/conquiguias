<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Formulario</title>
</head>

<body>
  <img src="logo1.png" style="width: 25%;" alt="">
  <h2 id="tituloFormulario">Cargando...</h2>
  <p id="contador"></p>

  <form id="formulario" style="display: none;">
    <input type="hidden" name="id" id="idFormulario">

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Correo: (Opcional)</label><br>
    <input type="email" name="correo"><br><br>

    <label>Edad: (Opcional)</label><br>
    <input type="number" name="edad"><br><br>

    <label>Tel칠fono:</label><br>
    <input type="tel" name="telefono" required><br><br>

    <label>Asociaci칩n o campo:</label><br>
    <input type="text" name="asociacion" required><br><br>

    <button type="submit">Enviar</button>
  </form>

  <p id="mensaje"></p>

  <h3>游늵 Respuestas registradas | Se actualiza cada 5 minutos.</h3><p id="contadorRecarga">游댃 Pr칩xima recarga en: <span id="segundos">300</span> segundos</p>

  <p>Informaci칩n exclusiva para instructores y directores. Su informaci칩n es borrada despu칠s de 90 d칤as</p>
  <table border="1" id="tablaRespuestas" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr>
        <th>#</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Edad</th>
        <th>Tel칠fono</th>
        <th>Asociaci칩n</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>


  <script>
    /* ---------- Reemplazar la funci칩n cargarRespuestas por este bloque ---------- */
    async function cargarRespuestas(idFormulario) {
      const tabla = document.getElementById("tablaRespuestas");
      const tablaBody = tabla.querySelector("tbody");
    
      // Actualizar encabezado para incluir las nuevas columnas (si quieres mantener el header est치tico, puedes omitir esto)
      const thead = tabla.querySelector("thead");
      thead.innerHTML = `
        <tr>
          <th>#</th>
          <th>Nombre</th>
          <th>Correo</th>
          <th>Edad</th>
          <th>Tel칠fono</th>
          <th>Asociaci칩n</th>
          <th>N칰mero Asistencia</th>
          <th>쮸sisti칩?</th>
          <th>Examen</th>
          <th>Fecha</th>
        </tr>
      `;
    
      tablaBody.innerHTML = "<tr><td colspan='10'>Cargando respuestas...</td></tr>";
    
      try {
        const res = await fetch(`/api/verRespuestas?id=${encodeURIComponent(idFormulario)}`);
        if (!res.ok) {
          tablaBody.innerHTML = "<tr><td colspan='10'>No hay respuestas a칰n.</td></tr>";
          return;
        }
    
        const registros = await res.json();
    
        if (!Array.isArray(registros) || registros.length === 0) {
          tablaBody.innerHTML = "<tr><td colspan='10'>No hay respuestas a칰n.</td></tr>";
          return;
        }
    
        // Agrupar por correo (cada fila ser치 1 usuario con resumen)
        const mapa = new Map();
        registros.forEach(r => {
          const correo = (r.correo || "").toLowerCase() || `_sin_correo_${Math.random()}`;
          if (!mapa.has(correo)) {
            mapa.set(correo, { registros: [], nombre: r.nombre || "-", telefono: r.telefono || "-", asociacion: r.asociacion || "-" });
          }
          mapa.get(correo).registros.push(r);
        });
    
        // Construir filas de la tabla
        tablaBody.innerHTML = "";
        let contador = 1;
        for (const [correo, info] of mapa.entries()) {
          const regs = info.registros;
    
          // Determinar n칰mero de asistencias:
          // 1) si los registros individuales tienen campo numeroAsistencia -> tomar m치ximo
          // 2) si el registro tiene objeto asistencias -> contar valores true
          // 3) fallback: usar cantidad de registros
          let numeroAsistencia = 0;
          let asistenciasTrue = 0;
          regs.forEach(r => {
            if (typeof r.numeroAsistencia === "number") {
              numeroAsistencia = Math.max(numeroAsistencia, r.numeroAsistencia);
            }
            if (r.asistencias && typeof r.asistencias === "object") {
              const c = Object.values(r.asistencias).filter(Boolean).length;
              asistenciasTrue = Math.max(asistenciasTrue, c);
            }
          });
    
          if (numeroAsistencia === 0 && asistenciasTrue > 0) numeroAsistencia = asistenciasTrue;
          if (numeroAsistencia === 0) numeroAsistencia = regs.length;
    
          // 쮸sisti칩? => Solo "S칤" si tiene las 3 asistencias (seg칰n tu regla)
          const asistioCompletamente = numeroAsistencia >= 3 ? "S칤" : "No";
    
          // Fecha m치s reciente
          const fechas = regs.map(r => r.fecha ? new Date(r.fecha) : null).filter(Boolean);
          const fechaUltima = fechas.length ? new Date(Math.max(...fechas.map(d => d.getTime()))) : null;
          const fechaTexto = fechaUltima ? fechaUltima.toLocaleString() : "-";
    
          // Mostrar bot칩n de examen solo si complet칩 las 3 asistencias
          const examenHTML = numeroAsistencia >= 3
            ? `<button class="btn-examen" data-correo="${correo}">Hacer examen</button>`
            : "No puede hacer examen";
    
          // Inserta fila
          tablaBody.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${contador}</td>
              <td>${escapeHtml(info.nombre)}</td>
              <td>${escapeHtml(correo)}</td>
              <td>${escapeHtml(regs[0].edad || "")}</td>
              <td>${escapeHtml(info.telefono)}</td>
              <td>${escapeHtml(info.asociacion)}</td>
              <td style="text-align:center">${numeroAsistencia}</td>
              <td style="text-align:center">${asistioCompletamente}</td>
              <td style="text-align:center">${examenHTML}</td>
              <td>${fechaTexto}</td>
            </tr>
          `);
          contador++;
        }
    
        // A침adir listener para botones "Hacer examen"
        document.querySelectorAll(".btn-examen").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const correo = e.currentTarget.dataset.correo;
            // Aqu칤 abres o muestras el formulario de examen; por ahora mostramos alerta
            // (Reemplaza esto por la l칩gica que necesites para mostrar el examen en la p치gina)
            alert(`Abrir examen para: ${correo}`);
            // Si quieres mostrar un formulario debajo de la tabla, puedes llamara una funci칩n que genere el HTML del examen y lo inserte.
          });
        });
    
      } catch (error) {
        console.error("Error al cargar respuestas:", error);
        tablaBody.innerHTML = "<tr><td colspan='10'>丘멆잺 Error al conectar con el servidor.</td></tr>";
      }
    }
    
    /* ---------- helper: escape b치sico para evitar inyecci칩n accidental ---------- */
    function escapeHtml(str) {
      if (!str && str !== 0) return "";
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    </script>
    
  
  

</body>

</html>