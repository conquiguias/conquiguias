<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario de Asistencias</title>
  <style>
    button { margin: 5px; }
    #formulario { margin-top: 20px; }
  </style>
</head>
<body>
  <h2 id="tituloFormulario">Cargando formulario...</h2>
  <p id="contador"></p>

  <!-- Formulario inicial -->
  <form id="formulario" style="display:none;">
    <input type="hidden" name="id" id="idFormulario">
    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>
    <label>Correo (Opcional):</label><br>
    <input type="email" name="correo"><br><br>
    <label>Edad (Opcional):</label><br>
    <input type="number" name="edad"><br><br>
    <label>TelÃ©fono:</label><br>
    <input type="tel" name="telefono" required><br><br>
    <label>AsociaciÃ³n o campo:</label><br>
    <input type="text" name="asociacion" required><br><br>
    <button type="submit">Registrar Primera Asistencia</button>
  </form>

  <div id="botonesAsistencia" style="margin-top:20px; display:none;">
    <button id="btnSegunda" disabled>Registrar Segunda Asistencia</button>
    <span id="contadorSegunda"></span><br>
    <button id="btnTercera" disabled>Registrar Tercera Asistencia</button>
    <span id="contadorTercera"></span>
  </div>

  <p id="mensaje"></p>

  <h3>ðŸ“Š Respuestas registradas</h3>
  <table border="1" id="tablaRespuestas" style="border-collapse:collapse;width:100%;">
    <thead>
      <tr>
        <th>#</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Edad</th>
        <th>TelÃ©fono</th>
        <th>AsociaciÃ³n</th>
        <th>NÃºmero Asistencia</th>
        <th>Â¿AsistiÃ³?</th>
        <th>Examen</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
// UUID visitante
let visitanteId = localStorage.getItem("visitanteId");
if (!visitanteId) {
  visitanteId = crypto.randomUUID();
  localStorage.setItem("visitanteId", visitanteId);
}

// Asistencias persistentes
let asistencias = JSON.parse(localStorage.getItem("asistencias")) || {};

// ConfiguraciÃ³n de tiempos en ms
const tiempoSegunda = 30 * 60 * 1000; // 30 min
const tiempoTercera = 10 * 60 * 1000; // 10 min

document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(location.search);
  const id = params.get("id");
  if (!id) return;

  document.getElementById("idFormulario").value = id;
  document.getElementById("tituloFormulario").textContent = "Formulario de Asistencia";

  const form = document.getElementById("formulario");
  const btnSegunda = document.getElementById("btnSegunda");
  const btnTercera = document.getElementById("btnTercera");
  const contadorSegunda = document.getElementById("contadorSegunda");
  const contadorTercera = document.getElementById("contadorTercera");

  // Cargar tabla
  cargarRespuestas();

  // Mostrar botones asistencia si hay registro
  const registro = asistencias[visitanteId];
  if (registro) {
    form.style.display = "none";
    document.getElementById("botonesAsistencia").style.display = "block";

    // CronÃ³metro segunda asistencia
    if (!registro.segunda) {
      iniciarCronometro(registro.primera + tiempoSegunda, btnSegunda, contadorSegunda);
    } else {
      btnSegunda.disabled = true;
      iniciarCronometro(registro.segunda + tiempoTercera, btnTercera, contadorTercera);
    }
  } else {
    form.style.display = "block";
  }

  // Submit primera asistencia
  form.addEventListener("submit", async e => {
    e.preventDefault();
    const datos = Object.fromEntries(new FormData(form).entries());
    datos.visitanteId = visitanteId;
    datos.numeroAsistencia = 1;

    // Guardar en backend
    const res = await fetch("/api/guardar", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(datos)
    });
    if (res.ok) {
      asistencias[visitanteId] = { primera: Date.now() };
      localStorage.setItem("asistencias", JSON.stringify(asistencias));
      form.style.display = "none";
      document.getElementById("botonesAsistencia").style.display = "block";
      iniciarCronometro(asistencias[visitanteId].primera + tiempoSegunda, btnSegunda, contadorSegunda);
      cargarRespuestas();
      alert("Primera asistencia registrada âœ…");
    } else {
      alert("Error al registrar. Usuario ya registrado");
    }
  });

  // BotÃ³n segunda asistencia
  btnSegunda.addEventListener("click", async () => {
    const datos = { visitantId: visitanteId, numeroAsistencia: 2, id };
    const res = await fetch("/api/guardar", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(datos)
    });
    if (res.ok) {
      asistencias[visitanteId].segunda = Date.now();
      localStorage.setItem("asistencias", JSON.stringify(asistencias));
      btnSegunda.disabled = true;
      iniciarCronometro(asistencias[visitanteId].segunda + tiempoTercera, btnTercera, contadorTercera);
      cargarRespuestas();
      alert("Segunda asistencia registrada âœ…");
    }
  });

  // BotÃ³n tercera asistencia
  btnTercera.addEventListener("click", async () => {
    const datos = { visitantId: visitanteId, numeroAsistencia: 3, id };
    const res = await fetch("/api/guardar", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(datos)
    });
    if (res.ok) {
      asistencias[visitanteId].tercera = Date.now();
      localStorage.setItem("asistencias", JSON.stringify(asistencias));
      btnTercera.disabled = true;
      cargarRespuestas();
      alert("Tercera asistencia registrada âœ…");
    }
  });

});

// CronÃ³metro
function iniciarCronometro(tiempoFin, boton, span) {
  const intervalo = setInterval(() => {
    const ahora = Date.now();
    const restante = tiempoFin - ahora;
    if (restante <= 0) {
      clearInterval(intervalo);
      boton.disabled = false;
      span.textContent = "";
      return;
    }
    const min = Math.floor(restante/60000);
    const seg = Math.floor((restante%60000)/1000);
    span.textContent = `Disponible en ${min}:${seg.toString().padStart(2,"0")}`;
  }, 1000);
}

// Cargar tabla de asistencias
async function cargarRespuestas() {
  const tbody = document.querySelector("#tablaRespuestas tbody");
  tbody.innerHTML = "<tr><td colspan='9'>Cargando...</td></tr>";
  try {
    const res = await fetch(`/api/verRespuestas`);
    if (!res.ok) { tbody.innerHTML="<tr><td colspan='9'>No hay respuestas</td></tr>"; return; }
    const data = await res.json();
    tbody.innerHTML = "";
    data.forEach((r,i)=>{
      const asistio1 = r.numeroAsistencia>=1;
      const asistio2 = r.numeroAsistencia>=2;
      const asistio3 = r.numeroAsistencia>=3;
      const examen = (asistio1 && asistio2 && asistio3) ? `<button>Hacer examen</button>` : "No puede hacer examen";
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${i+1}</td>
          <td>${r.nombre}</td>
          <td>${r.correo||"-"}</td>
          <td>${r.edad||"-"}</td>
          <td>${r.telefono||"-"}</td>
          <td>${r.asociacion||"-"}</td>
          <td>1${asistio2? ',2':''}${asistio3?',3':''}</td>
          <td>${asistio1?'SÃ­':'No'},${asistio2?'SÃ­':'No'},${asistio3?'SÃ­':'No'}</td>
          <td>${examen}</td>
        </tr>
      `);
    });
  } catch(e){ console.error(e); }
}
</script>
</body>
</html>
