<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario de Asistencias</title>
  <style>
    button:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
  <img src="logo1.png" style="width: 25%;" alt="">
  <h2 id="tituloFormulario">Cargando...</h2>
  <p id="contador"></p>

  <!-- Formulario para primera asistencia -->
  <form id="formulario" style="display:none;">
    <input type="hidden" name="id" id="idFormulario">

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Correo: (Opcional)</label><br>
    <input type="email" name="correo"><br><br>

    <label>Edad: (Opcional)</label><br>
    <input type="number" name="edad"><br><br>

    <label>Tel茅fono:</label><br>
    <input type="tel" name="telefono" required><br><br>

    <label>Asociaci贸n o campo:</label><br>
    <input type="text" name="asociacion" required><br><br>

    <button type="submit">Registrar Primera Asistencia</button>
  </form>

  <!-- Botones de segunda y tercera asistencia -->
  <div id="botonesAsistencia" style="margin-top:20px; display:none;">
    <button id="btnSegunda" disabled>Segunda Asistencia</button>
    <button id="btnTercera" disabled>Tercera Asistencia</button>
  </div>

  <p id="mensaje"></p>

  <h3> Respuestas registradas | Se actualiza cada 5 minutos.</h3>
  <p id="contadorRecarga"> Pr贸xima recarga en: <span id="segundos">300</span> segundos</p>

  <p>Informaci贸n exclusiva para instructores y directores. Su informaci贸n es borrada despu茅s de 90 d铆as</p>

  <table border="1" id="tablaRespuestas" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr>
        <th>#</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Edad</th>
        <th>Tel茅fono</th>
        <th>Asociaci贸n</th>
        <th>N煤mero Asistencia</th>
        <th>驴Asisti贸?</th>
        <th>Examen</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  // Generar UUID
  function generarUUID() { return crypto.randomUUID(); }

  let visitanteId = localStorage.getItem("visitanteId");
  if (!visitanteId) {
    visitanteId = generarUUID();
    localStorage.setItem("visitanteId", visitanteId);
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    if (!id) return;

    document.getElementById("idFormulario").value = id;
    document.getElementById("tituloFormulario").textContent = "Formulario: " + id;

    const btnSegunda = document.getElementById("btnSegunda");
    const btnTercera = document.getElementById("btnTercera");
    const formulario = document.getElementById("formulario");
    const botonesDiv = document.getElementById("botonesAsistencia");
    botonesDiv.style.display = "block";

    // Cargar registros existentes
    async function cargarRespuestas() {
      const tablaBody = document.querySelector("#tablaRespuestas tbody");
      const res = await fetch(`/api/verRespuestas?id=${id}`);
      const registros = await res.json();

      tablaBody.innerHTML = "";
      registros.forEach((r,index)=>{
        r.asistencias.forEach((asistio,num)=>{
          let examen = "-";
          if (r.asistencias.length === 3 && r.asistencias.every(a=>a===true)) {
            examen = `<button onclick="alert('Hacer examen de ${r.nombre}')">Hacer Examen</button>`;
          } else if(num===2) examen="No puede hacer examen";
          tablaBody.insertAdjacentHTML("beforeend",`
            <tr>
              <td>${index+1}</td>
              <td>${r.nombre}</td>
              <td>${r.correo||"-"}</td>
              <td>${r.edad||"-"}</td>
              <td>${r.telefono}</td>
              <td>${r.asociacion}</td>
              <td>${num+1}</td>
              <td>${asistio?"S铆":"No"}</td>
              <td>${num===2?examen:"-"}</td>
            </tr>
          `);
        });
      });
    }

    await cargarRespuestas();

    // Revisar si el usuario ya tiene registro
    const resUsuarios = await fetch(`/api/verRespuestas?id=${id}`);
    const registros = await resUsuarios.json();
    const registroUsuario = registros.find(r=>r.visitanteId===visitanteId);

    if(!registroUsuario){
      formulario.style.display="block";
    } else {
      formulario.style.display="none";
      if(registroUsuario.asistencias[0] && !registroUsuario.asistencias[1]){
        // Segunda asistencia bloqueada 30 min
        btnSegunda.disabled = true;
        setTimeout(()=> btnSegunda.disabled=false, 30*60*1000);
      }
      if(registroUsuario.asistencias[1] && !registroUsuario.asistencias[2]){
        // Tercera asistencia bloqueada 10 min
        btnTercera.disabled = true;
        setTimeout(()=> btnTercera.disabled=false, 10*60*1000);
      }
    }

    // Registrar primera asistencia
    formulario.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const datos = Object.fromEntries(new FormData(formulario).entries());
      datos.visitanteId = visitanteId;
      datos.numeroAsistencia = 1;
      datos.asistencias = [true];
      const res = await fetch("/api/guardar",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(datos)
      });
      if(res.ok){
        alert("Primera asistencia registrada");
        formulario.style.display="none";
        btnSegunda.disabled = true;
        setTimeout(()=> btnSegunda.disabled=false, 30*60*1000);
        await cargarRespuestas();
      } else alert("Error al registrar");
    });

    // Registrar segunda asistencia
    btnSegunda.addEventListener("click", async ()=>{
      const res = await fetch("/api/guardar",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({id,visitanteId,numeroAsistencia:2})
      });
      if(res.ok){
        alert("Segunda asistencia registrada");
        btnSegunda.disabled=true;
        btnTercera.disabled=true;
        setTimeout(()=> btnTercera.disabled=false, 10*60*1000);
        await cargarRespuestas();
      }
    });

    // Registrar tercera asistencia
    btnTercera.addEventListener("click", async ()=>{
      const res = await fetch("/api/guardar",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({id,visitanteId,numeroAsistencia:3})
      });
      if(res.ok){
        alert("Tercera asistencia registrada");
        btnTercera.disabled=true;
        await cargarRespuestas();
      }
    });

    // Recarga cada 5 min
    let segundosRestantes = 300;
    setInterval(()=>{
      segundosRestantes--;
      document.getElementById("segundos").textContent = segundosRestantes;
      if(segundosRestantes<=0){
        cargarRespuestas();
        segundosRestantes=300;
      }
    },1000);
  });
</script>
</body>
</html>
