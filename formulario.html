<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Formulario</title>
</head>

<body>
  <img src="logo1.png" style="width: 25%;" alt="">
  <h2 id="tituloFormulario">Cargando...</h2>
  <p id="contador"></p>

  <form id="formulario" style="display: none;">
    <input type="hidden" name="id" id="idFormulario">

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Correo: (Opcional)</label><br>
    <input type="email" name="correo"><br><br>

    <label>Edad: (Opcional)</label><br>
    <input type="number" name="edad"><br><br>

    <label>Tel√©fono:</label><br>
    <input type="tel" name="telefono" required><br><br>

    <label>Asociaci√≥n o campo:</label><br>
    <input type="text" name="asociacion" required><br><br>

    <button type="submit">Enviar</button>
  </form>

  <p id="mensaje"></p>

  <h3>üìä Respuestas registradas | Se actualiza cada 5 minutos.</h3><p id="contadorRecarga">üîÑ Pr√≥xima recarga en: <span id="segundos">300</span> segundos</p>

  <p>Informaci√≥n exclusiva para instructores y directores. Su informaci√≥n es borrada despu√©s de 90 d√≠as</p>
  <table border="1" id="tablaRespuestas" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr>
        <th>#</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Edad</th>
        <th>Tel√©fono</th>
        <th>Asociaci√≥n</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>


  <script>
    // Generador b√°sico de UUID (queda como antes)
    function generarUUID() {
      return crypto.randomUUID();
    }
  
    let visitanteId = localStorage.getItem("visitanteId");
    if (!visitanteId) {
      visitanteId = generarUUID();
      localStorage.setItem("visitanteId", visitanteId);
    }
  
    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(location.search);
      const id = params.get("id");
  
      if (!id) {
        document.body.innerHTML = "<h2>‚ùå Error: ID de formulario no especificado.</h2>";
        return;
      }
  
      // Elementos
      const tituloEl = document.getElementById("tituloFormulario");
      const contadorEl = document.getElementById("contador");
      const formEl = document.getElementById("formulario");
      const mensajeEl = document.getElementById("mensaje");
      const segundosEl = document.getElementById("segundos");
      const tablaBody = document.querySelector("#tablaRespuestas tbody");
  
      // Botones din√°micos (los inyectamos debajo del form)
      const botonesContainer = document.createElement("div");
      botonesContainer.style.margin = "12px 0";
      formEl.parentNode.insertBefore(botonesContainer, formEl.nextSibling);
  
      const btnSegunda = document.createElement("button");
      btnSegunda.textContent = "Segunda Asistencia";
      btnSegunda.style.display = "none";
      btnSegunda.type = "button";
  
      const btnTercera = document.createElement("button");
      btnTercera.textContent = "Tercer Asistencia";
      btnTercera.style.display = "none";
      btnTercera.type = "button";
  
      botonesContainer.appendChild(btnSegunda);
      botonesContainer.appendChild(btnTercera);
  
      // Cargar metadata del formulario (para ventanas)
      async function obtenerFormulario() {
        const res = await fetch(`/api/obtenerFormulario?id=${encodeURIComponent(id)}`);
        if (!res.ok) throw new Error("Formulario no encontrado");
        return res.json();
      }
  
      let formInfo;
      try {
        formInfo = await obtenerFormulario();
      } catch (err) {
        console.error(err);
        document.body.innerHTML = "<h2>‚ùå Formulario no encontrado o error al cargar.</h2>";
        return;
      }
  
      tituloEl.textContent = formInfo.titulo || "Formulario";
  
      // calculo de ventanas (mismas reglas que en el endpoint)
      const creado = new Date(formInfo.creado || formInfo.fechaCierre || new Date().toISOString());
      const t1_inicio = creado.getTime();
      const t1_fin = t1_inicio + 30 * 60 * 1000; // 30 min
      const t2_inicio = t1_fin;
      const t2_fin = t2_inicio + 30 * 60 * 1000; // 30 min
      const t3_inicio = t2_fin;
      const t3_fin = t3_inicio + 10 * 60 * 1000; // 10 min
  
      function ventanaActual() {
        const now = Date.now();
        if (now >= t1_inicio && now <= t1_fin) return "primera";
        if (now > t2_inicio && now <= t2_fin) return "segunda";
        if (now > t3_inicio && now <= t3_fin) return "tercera";
        return null;
      }
  
      // Actualizar contador de cierre global (muestra tiempo hasta que termine la ventana actual o "cerrado")
      function actualizarContadorGlobal() {
        const v = ventanaActual();
        if (!v) {
          contadorEl.textContent = "‚õî No hay ventana de asistencia activa.";
          btnSegunda.style.display = "none";
          btnTercera.style.display = "none";
          return;
        }
        let fin;
        if (v === "primera") fin = t1_fin;
        if (v === "segunda") fin = t2_fin;
        if (v === "tercera") fin = t3_fin;
        const restanteMs = fin - Date.now();
        if (restanteMs <= 0) {
          contadorEl.textContent = "‚õî La ventana actual ha terminado.";
          btnSegunda.style.display = "none";
          btnTercera.style.display = "none";
          return;
        }
        const m = Math.floor((restanteMs / 1000 / 60) % 60);
        const s = Math.floor((restanteMs / 1000) % 60);
        contadorEl.textContent = `‚è≥ Ventana actual: ${v.toUpperCase()} ‚Äî tiempo restante ${m}:${s.toString().padStart(2,"0")}`;
        // mostrar botones seg√∫n ventana
        btnSegunda.style.display = (v === "segunda") ? "inline-block" : "none";
        btnTercera.style.display = (v === "tercera") ? "inline-block" : "none";
      }
  
      actualizarContadorGlobal();
      setInterval(actualizarContadorGlobal, 1000);
  
      // Funci√≥n para cargar respuestas y poblar la tabla
      async function cargarRespuestas() {
        tablaBody.innerHTML = "<tr><td colspan='7'>Cargando respuestas...</td></tr>";
        try {
          const res = await fetch(`/api/verRespuestas?id=${encodeURIComponent(id)}`);
          if (!res.ok) {
            tablaBody.innerHTML = "<tr><td colspan='7'>No hay respuestas a√∫n.</td></tr>";
            return;
          }
          const respuestas = await res.json();
          if (!respuestas.length) {
            tablaBody.innerHTML = "<tr><td colspan='7'>No hay respuestas a√∫n.</td></tr>";
            return;
          }
  
          // Cabecera: #, Nombre, Tel√©fono, A1, A2, A3, ¬øExamen?
          tablaBody.innerHTML = "";
          respuestas.forEach((r, i) => {
            const a1 = r.asistencias && r.asistencias["1"] && r.asistencias["1"].asistio === "S√≠" ? "S√≠" : "No";
            const a2 = r.asistencias && r.asistencias["2"] && r.asistencias["2"].asistio === "S√≠" ? "S√≠" : "No";
            const a3 = r.asistencias && r.asistencias["3"] && r.asistencias["3"].asistio === "S√≠" ? "S√≠" : "No";
            const puedeExamen = a1 === "S√≠" && a2 === "S√≠" && a3 === "S√≠";
            const examenCell = puedeExamen
              ? `<button data-telefono="${r.telefono}" class="btn-hacer-examen">Hacer examen</button>`
              : `No puede hacer examen`;
  
            const fila = `
              <tr>
                <td>${i + 1}</td>
                <td>${r.nombre || "‚Äî"}</td>
                <td>${r.telefono || "‚Äî"}</td>
                <td>${a1}</td>
                <td>${a2}</td>
                <td>${a3}</td>
                <td>${examenCell}</td>
              </tr>
            `;
            tablaBody.insertAdjacentHTML("beforeend", fila);
          });
  
          // A√±adir listeners para botones de examen (si luego implementas la UI de examen)
          document.querySelectorAll(".btn-hacer-examen").forEach(btn => {
            btn.addEventListener("click", (ev) => {
              const tel = ev.currentTarget.dataset.telefono;
              // aqu√≠ puedes abrir / mostrar el formulario de examen para ese tel√©fono
              alert("Abrir formulario de examen para: " + tel);
              // (implantar la UI de examen ser√° la siguiente etapa)
            });
          });
  
        } catch (err) {
          console.error(err);
          tablaBody.innerHTML = "<tr><td colspan='7'>Error al cargar respuestas.</td></tr>";
        }
      }
  
      // Cargar respuestas al inicio y cada 5 minutos
      cargarRespuestas();
      setInterval(cargarRespuestas, 5 * 60 * 1000);
  
      // --- HANDLERS para marcar asistencias ---
      async function marcarAsistencia(accion) {
        // acci√≥n: "primera" (viene del submit), "segunda" o "tercera" (botones)
        // Recolectar datos del form
        const fd = new FormData(formEl);
        const datos = Object.fromEntries(fd.entries());
        datos.id = id;
        // For segunda/tercera, requerimos telefono para identificar al usuario
        if (!datos.telefono) {
          mensajeEl.textContent = "Por favor ingresa tu tel√©fono para marcar asistencia.";
          return;
        }
        // enviar petici√≥n
        try {
          const res = await fetch("/api/guardarAsistencia", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id,
              nombre: datos.nombre,
              correo: datos.correo,
              edad: datos.edad,
              telefono: datos.telefono,
              asociacion: datos.asociacion,
              accion // "primera" | "segunda" | "tercera" (note: endpoint usa ventana actual)
            })
          });
          const body = await res.json();
          if (!res.ok) {
            mensajeEl.textContent = body.error || "Error al marcar asistencia.";
            return;
          }
          mensajeEl.textContent = "‚úÖ Asistencia registrada correctamente.";
          // Si fue la primera, ocultamos el formulario (comportamiento anterior)
          if (accion === "primera") {
            formEl.reset();
            formEl.style.display = "none";
          }
          // refrescar tabla
          cargarRespuestas();
        } catch (err) {
          console.error(err);
          mensajeEl.textContent = "‚ùå Ocurri√≥ un error al comunicarse con el servidor.";
        }
      }
  
      // submit del formulario -> intenta registrar primera asistencia (si ventana ok)
      formEl.addEventListener("submit", async function(e) {
        e.preventDefault();
        await marcarAsistencia("primera");
      });
  
      // segunda / tercera botones
      btnSegunda.addEventListener("click", async () => {
        // pedimos confirmaci√≥n y tel√©fono (ya est√° en el formulario)
        // Si el usuario ya ingres√≥ los datos antes, podemos tomar el telefono del formulario.
        await marcarAsistencia("segunda");
      });
      btnTercera.addEventListener("click", async () => {
        await marcarAsistencia("tercera");
      });
  
      // Fin DOMContentLoaded
    });
  </script>
  

</body>

</html>