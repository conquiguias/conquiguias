<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formulario de Asistencias</title>
<style>
  #botonesAsistencia button { margin-right: 10px; margin-top:10px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border:1px solid #000; padding:5px; text-align:center; }
</style>
</head>
<body>
<img src="logo1.png" style="width:25%" alt="">
<h2 id="tituloFormulario">Cargando...</h2>
<p id="contador"></p>

<form id="formulario" style="display:none;">
  <input type="hidden" name="id" id="idFormulario">
  <label>Nombre:</label><br>
  <input type="text" name="nombre" required><br><br>
  <label>Correo: (Opcional)</label><br>
  <input type="email" name="correo"><br><br>
  <label>Edad: (Opcional)</label><br>
  <input type="number" name="edad"><br><br>
  <label>TelÃ©fono:</label><br>
  <input type="tel" name="telefono" required><br><br>
  <label>AsociaciÃ³n o campo:</label><br>
  <input type="text" name="asociacion" required><br><br>
  <button type="submit">Enviar Primera Asistencia</button>
</form>

<div id="botonesAsistencia" style="display:none;">
  <button id="btnSegunda" disabled>Registrar Segunda Asistencia</button>
  <button id="btnTercera" disabled>Registrar Tercera Asistencia</button>
</div>

<p id="mensaje"></p>

<h3>ðŸ“Š Respuestas registradas</h3>
<table id="tablaRespuestas">
  <thead>
    <tr>
      <th>#</th><th>Nombre</th><th>Correo</th><th>Edad</th>
      <th>TelÃ©fono</th><th>AsociaciÃ³n</th><th>Fecha</th>
      <th>NÂ° Asistencia</th><th>Â¿AsistiÃ³?</th><th>Examen</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const DURACION_ASISTENCIAS = [30,30,10]; // minutos
let visitanteId = localStorage.getItem("visitanteId");
if(!visitanteId){ visitanteId = crypto.randomUUID(); localStorage.setItem("visitanteId", visitanteId); }

document.addEventListener("DOMContentLoaded", async ()=>{
  const params = new URLSearchParams(location.search);
  const id = params.get("id");
  if(!id) return;

  const tituloEl = document.getElementById("tituloFormulario");
  const contadorEl = document.getElementById("contador");
  const formulario = document.getElementById("formulario");
  const mensaje = document.getElementById("mensaje");
  const btnSegunda = document.getElementById("btnSegunda");
  const btnTercera = document.getElementById("btnTercera");
  const botonesDiv = document.getElementById("botonesAsistencia");

  // Obtener formulario desde backend
  const formRes = await fetch(`/api/obtenerFormulario?id=${id}`);
  if(!formRes.ok){ tituloEl.textContent="Formulario no encontrado"; return; }
  const data = await formRes.json();
  tituloEl.textContent = data.titulo;

  const fechaInicio = new Date(data.fechaInicio);
  const fechaCierre = new Date(data.fechaCierre);

  // CronÃ³metro principal sincronizado con servidor
  const actualizarContador = ()=>{
    const ahora = new Date();
    let restante = fechaCierre - ahora;
    if(restante<=0){
      contadorEl.textContent="â›” El formulario ha caducado";
      formulario.style.display="none";
      btnSegunda.disabled = true; btnTercera.disabled = true;
      return;
    }
    const min = Math.floor(restante/1000/60); 
    const seg = Math.floor(restante/1000%60);
    contadorEl.textContent=`â³ Tiempo restante: ${min}:${seg.toString().padStart(2,"0")}`;
  };
  actualizarContador(); setInterval(actualizarContador,1000);

  // Cargar respuestas y actualizar botones
  async function cargarRespuestas(){
    const tbody = document.querySelector("#tablaRespuestas tbody");
    tbody.innerHTML = "<tr><td colspan='10'>Cargando...</td></tr>";
    const res = await fetch(`/api/verRespuestas?id=${id}`);
    if(!res.ok){ tbody.innerHTML="<tr><td colspan='10'>Error</td></tr>"; return; }
    const respuestas = await res.json();
    tbody.innerHTML="";
    let registroUsuario = null;
    respuestas.forEach((r,i)=>{
      if(r.visitanteId===visitanteId) registroUsuario=r;
      r.asistencias.forEach((a,index)=>{
        let examen="-";
        if(r.asistencias.every(v=>v)) examen=`<button onclick="alert('Hacer examen ${r.nombre}')">Hacer Examen</button>`;
        else if(index===2) examen="No puede hacer examen";
        tbody.insertAdjacentHTML("beforeend",`
          <tr>
            <td>${i+1}</td>
            <td>${r.nombre}</td>
            <td>${r.correo||"-"}</td>
            <td>${r.edad||"-"}</td>
            <td>${r.telefono}</td>
            <td>${r.asociacion}</td>
            <td>${new Date(r.fecha).toLocaleString()}</td>
            <td>${index+1}</td>
            <td>${a?"SÃ­":"No"}</td>
            <td>${index===2?examen:"-"}</td>
          </tr>
        `);
      });
    });

    // Mostrar botones segÃºn asistencias
    botonesDiv.style.display="block";
    if(!registroUsuario){
      formulario.style.display="block";
      btnSegunda.disabled = true; btnTercera.disabled = true;
    }else{
      formulario.style.display="none";
      btnSegunda.disabled = !registroUsuario.asistencias[0];
      btnTercera.disabled = !registroUsuario.asistencias[1];
    }
  }

  await cargarRespuestas();

  // Manejo formulario
  formulario.addEventListener("submit", async e=>{
    e.preventDefault();
    const datos = Object.fromEntries(new FormData(formulario).entries());
    datos.id=id; datos.visitanteId=visitanteId;
    datos.numeroAsistencia=1;
    const res = await fetch("/api/guardar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(datos)});
    if(res.ok){ mensaje.textContent="âœ… Primera asistencia registrada"; formulario.style.display="none"; await cargarRespuestas(); }
    else{ const err = await res.json(); mensaje.textContent=`âŒ ${err.error}`; }
  });

  // Botones asistencia
  btnSegunda.addEventListener("click", async ()=>{
    const datos = {id, visitanteId, numeroAsistencia:2};
    const res = await fetch("/api/guardar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(datos)});
    if(res.ok){ mensaje.textContent="âœ… Segunda asistencia registrada"; await cargarRespuestas(); }
    else{ const err = await res.json(); mensaje.textContent=`âŒ ${err.error}`; }
  });
  btnTercera.addEventListener("click", async ()=>{
    const datos = {id, visitanteId, numeroAsistencia:3};
    const res = await fetch("/api/guardar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(datos)});
    if(res.ok){ mensaje.textContent="âœ… Tercera asistencia registrada"; await cargarRespuestas(); }
    else{ const err = await res.json(); mensaje.textContent=`âŒ ${err.error}`; }
  });

  // Auto-refresco tabla cada 5 minutos
  let segs = 300;
  setInterval(async ()=>{
    segs--; document.getElementById("segundos").textContent=segs;
    if(segs<=0){ await cargarRespuestas(); segs=300; }
  },1000);

});
</script>
</body>
</html>
